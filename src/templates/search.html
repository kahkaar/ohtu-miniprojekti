{% extends "layout.html" %}
{% block title %}Advanced Search{% endblock %}

{% block body %}
<div class="page-header">
  <h1><i class="bi bi-search text-primary"></i> Advanced Citation Search</h1>
  <p class="lead text-muted">Use filters and sorting to find exactly what you need</p>
</div>

<!-- Search Form -->
<div class="form-section">
  <form method="get" action="/citations/search" class="search-form">
    
    <!-- General Search -->
    <div class="mb-4">
      <h5><i class="bi bi-search"></i> General Search</h5>
      <input type="text" 
             name="q" 
             class="form-control form-control-lg" 
             placeholder="Search all fields (title, author, year, etc.)..." 
             value="{{ request.args.get('q','') }}">
      <div class="form-text">Search across all citation fields at once</div>
    </div>

    <hr class="my-4">

    <!-- Basic Filters -->
    <div class="mb-4">
      <h5><i class="bi bi-funnel"></i> Basic Filters</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="citation_key" class="form-label">Citation Key</label>
          <input type="text" 
                 name="citation_key" 
                 id="citation_key"
                 class="form-control" 
                 placeholder="e.g., Smith2023" 
                 value="{{ request.args.get('citation_key','') }}">
        </div>
        <div class="col-md-6">
          <label for="entry_type" class="form-label">Entry Type</label>
          <select name="entry_type" id="entry_type" class="form-select">
            <option value="">Any entry type</option>
            {% for et in entry_types %}
            <option value="{{ et.name }}" {% if et.name==request.args.get('entry_type') %}selected{% endif %}>
              {{ et.name }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Author Filter -->
    <div class="mb-4">
      <h5><i class="bi bi-person"></i> Author</h5>
      <input type="text" 
             name="author" 
             class="form-control" 
             placeholder="Author name..." 
             value="{{ request.args.get('author','') }}">
    </div>

    <!-- Year Range -->
    <div class="mb-4">
      <h5><i class="bi bi-calendar-range"></i> Year Range</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="year_from" class="form-label">From Year</label>
          <input type="number" 
                 name="year_from" 
                 id="year_from"
                 class="form-control" 
                 placeholder="e.g., 2020" 
                 value="{{ request.args.get('year_from','') }}">
        </div>
        <div class="col-md-6">
          <label for="year_to" class="form-label">To Year</label>
          <input type="number" 
                 name="year_to" 
                 id="year_to"
                 class="form-control" 
                 placeholder="e.g., 2024" 
                 value="{{ request.args.get('year_to','') }}">
        </div>
      </div>
    </div>

    <!-- Sorting Options -->
    <div class="mb-4">
      <h5><i class="bi bi-sort-down"></i> Sorting</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="sort_by" class="form-label">Sort By</label>
          <select name="sort_by" id="sort_by" class="form-select">
            <option value="">Default (ID)</option>
            <option value="year" {% if request.args.get('sort_by')=="year" %}selected{% endif %}>Year</option>
            <option value="citation_key" {% if request.args.get('sort_by')=="citation_key" %}selected{% endif %}>Citation Key</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="direction" class="form-label">Direction</label>
          <select name="direction" id="direction" class="form-select">
            <option value="asc" {% if request.args.get('direction')=="asc" %}selected{% endif %}>Ascending</option>
            <option value="desc" {% if request.args.get('direction')=="desc" %}selected{% endif %}>Descending</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="bi bi-search"></i> Search
      </button>
      <a href="{{ url_for('citations_search') }}" class="btn btn-outline-secondary btn-lg">
        <i class="bi bi-x-circle"></i> Clear Filters
      </a>
      <a href="{{ url_for('citations_view') }}" class="btn btn-outline-primary btn-lg">
        <i class="bi bi-list-ul"></i> View All
      </a>
    </div>
  </form>
</div>

<!-- Search Results -->
<div class="mt-4">
  <h4 class="mb-3">
    <i class="bi bi-collection"></i> Search Results
    {% if citations %}
      <span class="badge bg-primary">{{ citations|length }}</span>
    {% endif %}
  </h4>

  {% if citations %}
    {% for c in citations %}
    <div class="citation-card" id="{{ c.id }}-{{c.citation_key}}">
      <div class="citation-header">
        <span class="badge bg-info">@{{ c.entry_type }}</span>
        <strong>{{ c.citation_key }}</strong>
      </div>
      <div class="citation-content">
        {{ c.to_human_readable() }}
      </div>
      <div class="citation-actions">
        <a href="{{ url_for('edit_citation', citation_id=c.id) }}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-pencil"></i> Edit
        </a>
        <button type="button" 
                class="btn btn-sm btn-outline-danger" 
                data-bs-toggle="modal" 
                data-bs-target="#deleteModal{{ c.id }}">
          <i class="bi bi-trash"></i> Delete
        </button>
        <a href="{{ url_for('show_bibtex', citation_id=c.id) }}" class="btn btn-sm btn-outline-success">
          <i class="bi bi-code-square"></i> BibTeX
        </a>
      </div>

      <!-- Delete Confirmation Modal -->
      <div class="modal fade" id="deleteModal{{ c.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ c.id }}" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteModalLabel{{ c.id }}">
                <i class="bi bi-exclamation-triangle text-warning"></i> Confirm Deletion
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this citation?</p>
              <p class="text-muted"><strong>Citation Key:</strong> {{ c.citation_key }}</p>
              <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <form method="POST" action="{{ url_for('delete_citation', citation_id=c.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-danger">
                  <i class="bi bi-trash"></i> Delete Citation
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> No results found. Try adjusting your search criteria.
    </div>
  {% endif %}
</div>
{% endblock %}
