{% extends "layout.html" %}

{% block title %}Edit Citation{% endblock %}

{% block body %}

{% if citation %}
<h1>Edit Citation</h1>
<form method="POST" action="{{ url_for('edit_citation', citation_id=citation.id) }}">
  <label>Citation key:
    <input type="text" name="citation_key" value="{{ citation.citation_key }}" required>
  </label>
  <br>
  {% for f, val in citation.fields|dictsort %}
  <label>{{ f.replace("_", " ").capitalize() }}
    <input type="text" name="{{ f }}" value="{{ val }}">
  </label>
  <br>
  {% endfor %}

  {% if default_fields %}
  <fieldset>
    <legend>Add extra fields for this citation (won't be saved as global defaults)</legend>

    <div id="extra_fields_container">
      <!-- Existing extra rows will be appended here -->
    </div>

    <button type="button" id="add_extra">Add field</button>

    <!-- Template for a single extra field row -->
    <template id="extra_row_template">
      <div class="extra-row" style="margin-top:8px">
        <label>Field:
          <select class="extra-select">
            <option value="">-- select field --</option>
            {% for df in default_fields %}
            <option value="{{ df }}">{{ df.replace('_', ' ').capitalize() }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Value:
          <input type="text" class="extra-input" name="additional_field_value" placeholder="Value for chosen field">
        </label>
        <button type="button" class="remove-extra">Remove</button>
      </div>
    </template>

    <script>
      (function () {
        var container = document.getElementById('extra_fields_container');
        var tpl = document.getElementById('extra_row_template');
        var addBtn = document.getElementById('add_extra');

        function updateDisabledOptions() {
          // Collect selected values
          var selects = container.querySelectorAll('.extra-select');
          var chosen = {};
          selects.forEach(function (s) {
            if (s.value) chosen[s.value] = true;
          });

          // For every select, disable options that are chosen by others
          selects.forEach(function (s) {
            var options = s.options;
            for (var i = 0; i < options.length; i++) {
              var opt = options[i];
              if (opt.value === '') { opt.disabled = false; continue; }
              // allow the currently selected option on this select
              if (s.value === opt.value) {
                opt.disabled = false;
                continue;
              }
              opt.disabled = !!chosen[opt.value];
            }
          });
        }

        function bindRow(row) {
          var select = row.querySelector('.extra-select');
          var input = row.querySelector('.extra-input');
          var remove = row.querySelector('.remove-extra');

          function onChange() {
            var field = select.value || '';
            input.name = field || 'additional_field_value';
            updateDisabledOptions();
          }

          select.addEventListener('change', onChange);
          remove.addEventListener('click', function () {
            row.remove();
            updateDisabledOptions();
          });
        }

        addBtn.addEventListener('click', function () {
          var clone = tpl.content.firstElementChild.cloneNode(true);
          container.appendChild(clone);
          bindRow(clone);
          updateDisabledOptions();
        });

        // Prepopulate extra fields with any non-default fields that aren't already rendered
        (function initExistingExtras() {
          var existing = {{ citation.fields| tojson
        }} || {};
      var defaults = {{ default_fields| tojson }} || [];
      for (var k in existing) {
        if (!existing.hasOwnProperty(k)) continue;
        // skip default fields and fields that are already present as inputs in the form
        if (defaults.indexOf(k) !== -1) continue;
        // also skip keys if an input with that name already exists
        if (document.querySelector('input[name="' + k + '"]')) continue;

        // create a row and set values
        addBtn.click();
        var last = container.lastElementChild;
        var sel = last.querySelector('.extra-select');
        var inp = last.querySelector('.extra-input');
        sel.value = k;
        sel.dispatchEvent(new Event('change'));
        inp.value = existing[k];
        inp.name = k;
      }
        }) ();

      // initialize with one row if there are no existing extras
      if (!container.children.length) {
        addBtn.click();
      }
      }) ();
    </script>
  </fieldset>
  {% endif %}
  <br>
  {% if categories %}
  <label>Select an existing category:
    <select name="category">
      <option value="" selected>None</option>
      {% for c in categories or [] %}
      <option value="{{ c.name }}" {% if c.name in citation.categories %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </label>
  {% endif %}
  <label>Create a new category:
    <input type="text" name="category_new" placeholder="New Category">
  </label>
  <br>

  {% if tags %}
  <label>Select existing tags:
    <select name="tags" multiple>
      {% for t in tags or [] %}
      <option value="{{ t.name }}" {% if t.name in citation.tags %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
  </label>
  <br>
  {% endif %}
  <label>Create new tags (comma-separated):
    <input type="text" name="tags_new" placeholder="tag1, tag2">
  </label>

  <button type="submit">Save Changes</button>
</form>
{% else %}
<p>Citation not found.</p>
{% endif %}


<form action="/citations" method="get" style="display:inline; margin-top:10px;">
  <button type="submit">Back</button>
</form>

{% endblock %}
