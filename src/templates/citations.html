{% extends "layout.html" %}

{% block title %}Saved Citations{% endblock %}

{% block body %}
<h1>ğŸ“š Saved Citations</h1>
<div class="nav-links">
  <a href="{{ url_for('index') }}">Back to Main Page</a>
  <a href="{{ url_for('citations_search') }}">Search Citations</a>
</div>

{% if citations %}
<p style="color: #666; font-size: 16px; margin-top: 20px;">
  <strong>{{ citations|length }}</strong> citation(s) found
</p>
{% for c in citations %}
<div class="citation" id="{{ c.id }}-{{c.citation_key}}">
  <p>{{ c.show_category_and_tags() }}</p>
  <p><strong>@{{ c.entry_type }}</strong> &mdash; <strong>{{ c.citation_key }}</strong></p>
  <p style="margin-top: 8px;">{{ c.to_human_readable() }}</p>
  <div style="margin-top: 12px;">
    <form method="GET" action="{{ url_for('edit_citation', citation_id=c.id) }}" style="display:inline;">
      <button type="submit">âœï¸ Edit</button>
    </form>
    <form method="POST" action="{{ url_for('delete_citation', citation_id=c.id) }}" style="display:inline;">
      <button type="submit" class="btn-danger" onclick="return confirm('Are you sure you want to delete this citation?')">ğŸ—‘ï¸ Delete</button>
    </form>
    <form method="GET" action="{{ url_for('show_bibtex', citation_id=c.id) }}" style="display:inline;">
      <button type="submit" class="btn-secondary">ğŸ“„ View BibTeX</button>
    </form>
  </div>
  <label>
    <input type="checkbox" id="{{ c.id }}" name="{{ c.citation_key }}">
    Select {{ c.citation_key }} for export
  </label>
</div>
{% endfor %}

<h1>Export selected citations as .bib file</h1>
<form name="exportform" method="GET" action="{{ url_for('export_bibtex') }}">
  <button type="button" onclick="export_bibtex()">Export</button>
</form>

<script>
  function export_bibtex() {
    const form = document.forms['exportform'];
    const selectedIds = [];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(function (checkbox) {
      selectedIds.push(checkbox.id);
    });
    if (selectedIds.length === 0) {
      alert('Please select at least one citation to export.');
      return;
    }
    while (form.lastChild && form.lastChild.name === 'citation_ids') {
      form.removeChild(form.lastChild);
    }
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'citation_ids';
    input.value = selectedIds;
    form.appendChild(input);
    form.submit();
  }
</script>

{% else %}
<div style="text-align: center; padding: 60px 20px; background: #0f172a; border-radius: 8px; margin-top: 30px; border: 1px solid #334155;">
  <h2 style="color: #64748b;">No saved citations yet</h2>
  <p style="color: #64748b; margin: 20px 0;">Start by creating your first citation!</p>
  <a href="{{ url_for('index') }}" class="btn-link btn-link-primary">Create Citation</a>
</div>
{% endif %}
{% endblock %}
